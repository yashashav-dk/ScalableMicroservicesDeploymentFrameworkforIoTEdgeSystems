stages:
  - lint
  - test
  - build
  - integration-test
  - deploy

variables:
  DOCKER_REGISTRY: "${CI_REGISTRY}"
  DOCKER_TLS_CERTDIR: "/certs"
  GIT_SHA: "${CI_COMMIT_SHORT_SHA}"
  EKS_CLUSTER: "iot-edge-cluster"
  AWS_REGION: "us-east-1"
  NAMESPACE: "iot-edge"

# ─── Lint Stage ──────────────────────────────────────────────────────
lint:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install flake8
    - |
      for service in sensor-ingestion data-processor device-registry alert-manager edge-gateway; do
        echo "Linting ${service}..."
        flake8 microservices/${service}/app.py --max-line-length=120 --ignore=E501,W503
      done

# ─── Test Stage (parallel per service) ───────────────────────────────
.test_template: &test_template
  stage: test
  image: python:3.11-slim
  before_script:
    - cd microservices/${SERVICE_NAME}
    - pip install -r requirements.txt
  script:
    - python -m pytest tests/ -v --tb=short --junitxml=report.xml
  artifacts:
    reports:
      junit: microservices/${SERVICE_NAME}/report.xml
    when: always

test-sensor-ingestion:
  <<: *test_template
  variables:
    SERVICE_NAME: "sensor-ingestion"
  needs: ["lint"]

test-data-processor:
  <<: *test_template
  variables:
    SERVICE_NAME: "data-processor"
  needs: ["lint"]

test-device-registry:
  <<: *test_template
  variables:
    SERVICE_NAME: "device-registry"
  needs: ["lint"]

test-alert-manager:
  <<: *test_template
  variables:
    SERVICE_NAME: "alert-manager"
  needs: ["lint"]

test-edge-gateway:
  <<: *test_template
  variables:
    SERVICE_NAME: "edge-gateway"
  needs: ["lint"]

# ─── Build Stage (Docker-in-Docker) ─────────────────────────────────
.build_template: &build_template
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - |
      docker build \
        -t ${DOCKER_REGISTRY}/${SERVICE_NAME}:${GIT_SHA} \
        -t ${DOCKER_REGISTRY}/${SERVICE_NAME}:latest \
        microservices/${SERVICE_NAME}/
    - docker push ${DOCKER_REGISTRY}/${SERVICE_NAME}:${GIT_SHA}
    - docker push ${DOCKER_REGISTRY}/${SERVICE_NAME}:latest

build-sensor-ingestion:
  <<: *build_template
  variables:
    SERVICE_NAME: "sensor-ingestion"
  needs: ["test-sensor-ingestion"]

build-data-processor:
  <<: *build_template
  variables:
    SERVICE_NAME: "data-processor"
  needs: ["test-data-processor"]

build-device-registry:
  <<: *build_template
  variables:
    SERVICE_NAME: "device-registry"
  needs: ["test-device-registry"]

build-alert-manager:
  <<: *build_template
  variables:
    SERVICE_NAME: "alert-manager"
  needs: ["test-alert-manager"]

build-edge-gateway:
  <<: *build_template
  variables:
    SERVICE_NAME: "edge-gateway"
  needs: ["test-edge-gateway"]

# ─── Integration Test Stage ──────────────────────────────────────────
integration-test:
  stage: integration-test
  image: docker:24-dind
  services:
    - docker:24-dind
  needs:
    - build-sensor-ingestion
    - build-data-processor
    - build-device-registry
    - build-alert-manager
    - build-edge-gateway
  before_script:
    - apk add --no-cache docker-compose curl bash
  script:
    - docker-compose up -d --build
    - sleep 30
    - chmod +x ci-cd/scripts/integration_test.sh
    - bash ci-cd/scripts/integration_test.sh
  after_script:
    - docker-compose down --remove-orphans || true

# ─── Deploy Stage ────────────────────────────────────────────────────
deploy-staging:
  stage: deploy
  image: alpine/k8s:1.28.3
  environment:
    name: staging
    url: https://staging.iot-edge.example.com
  needs: ["integration-test"]
  script:
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER}-staging
    - chmod +x ci-cd/scripts/deploy.sh
    - ./ci-cd/scripts/deploy.sh ${GIT_SHA}
  only:
    - main
    - develop

deploy-production:
  stage: deploy
  image: alpine/k8s:1.28.3
  environment:
    name: production
    url: https://iot-edge.example.com
  needs: ["integration-test"]
  script:
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER}
    - chmod +x ci-cd/scripts/deploy.sh
    - ./ci-cd/scripts/deploy.sh ${GIT_SHA}
  only:
    - main
  when: manual
